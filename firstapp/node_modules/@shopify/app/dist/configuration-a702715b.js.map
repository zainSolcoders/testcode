{"version":3,"file":"configuration-a702715b.js","sources":["../src/cli/utilities/extensions/fetch-product-variant.ts","../src/cli/utilities/extensions/configuration.ts"],"sourcesContent":["import {api, error, session} from '@shopify/cli-kit'\n\nconst NoProductsError = (storeFqdn: string) => {\n  return new error.Abort(\n    'Could not find a product variant',\n    `Your store needs to have at least one product to test a \"checkout_ui_extension\",\\n\nYou can add a new product here: https://${storeFqdn}/admin/products/new`,\n  )\n}\n\n/**\n * Retrieve the first variant of the first product of the given store\n * @param store {string} Store FQDN\n * @returns {Promise<string>} variantID if exists\n */\nexport async function fetchProductVariant(store: string) {\n  const adminSession = await session.ensureAuthenticatedAdmin(store)\n  const query = api.graphql.FindProductVariantQuery\n  const result: api.graphql.FindProductVariantSchema = await api.admin.request(query, adminSession)\n  const products = result.products.edges\n  if (products.length === 0) throw NoProductsError(store)\n  const variantURL = result.products.edges[0].node.variants.edges[0].node.id\n  const variantId = variantURL.split('/').pop()\n  return variantId\n}\n","import {nodeExtensionsCLIPath} from './cli'\nimport {fetchProductVariant} from './fetch-product-variant'\nimport {App, UIExtension, getUIExtensionRendererVersion} from '../../models/app/app'\nimport {error, id, path} from '@shopify/cli-kit'\nimport {UIExtensionTypes} from 'cli/constants'\n\nconst MissingStoreError = () => new error.Bug('You need a store to test \"checkout_ui_extensions\"')\n\nexport interface ExtensionConfigOptions {\n  app: App\n  apiKey?: string\n  extensions: UIExtension[]\n  buildDirectory?: string\n  url?: string\n  port?: number\n  storeFqdn?: string\n}\n\n/**\n * The extensions' Go binary receives the configuration through\n * standard input as a YAML-encoded object. This function returns the\n * Javascript object representing the configuration necessary for building.\n * @param extension {UIExtension} Extension that will be built.\n * @returns\n */\nexport async function extensionConfig(options: ExtensionConfigOptions): Promise<unknown> {\n  const extensionsConfig = await Promise.all(\n    options.extensions.map(async (extension) => {\n      return {\n        uuid: `${extension.configuration.name}-${id.generateShortId()}`,\n        title: extension.configuration.name,\n        type: `${extension.configuration.type}`,\n        metafields: extension.configuration.metafields,\n        // eslint-disable-next-line @typescript-eslint/naming-convention\n        extension_points: [],\n        // eslint-disable-next-line @typescript-eslint/naming-convention\n        node_executable: await nodeExtensionsCLIPath(),\n        development: {\n          version: '1.0.0',\n          // eslint-disable-next-line @typescript-eslint/naming-convention\n          root_dir: path.relative(options.app.directory, extension.directory),\n          // eslint-disable-next-line @typescript-eslint/naming-convention\n          build_dir: options.buildDirectory\n            ? path.relative(extension.directory, options.buildDirectory)\n            : path.relative(extension.directory, extension.buildDirectory),\n          entries: {\n            main: path.relative(extension.directory, extension.entrySourceFilePath),\n          },\n          renderer: getUIExtensionRendererVersion(extension.configuration.type, options.app),\n          resource: await getUIExtensionResourceURL(extension.configuration.type, options.storeFqdn),\n        },\n      }\n    }),\n  )\n\n  return {\n    // eslint-disable-next-line @typescript-eslint/naming-convention\n    public_url: options.url,\n    port: options.port,\n    store: options.storeFqdn,\n    app: {\n      // eslint-disable-next-line @typescript-eslint/naming-convention\n      api_key: options.apiKey,\n    },\n    extensions: extensionsConfig,\n  }\n}\n\nexport async function getUIExtensionResourceURL(uiExtensionType: UIExtensionTypes, store?: string) {\n  switch (uiExtensionType) {\n    case 'checkout_ui_extension': {\n      if (!store) throw MissingStoreError()\n      const result = await fetchProductVariant(store)\n      return {url: `/cart/${result}:1`}\n    }\n    case 'checkout_post_purchase':\n    case 'beacon_extension':\n      // This is a temporary workaround to avoid Admin crash when dev'ing multiple extensions\n      // Issue at shopify/web: https://github.com/Shopify/web/blob/main/app/components/Extensions/hooks/useResourceUrlQuery.ts#L15-L37\n      return {url: 'invalid_url'}\n    case 'product_subscription':\n      return undefined\n  }\n}\n"],"names":[],"mappings":"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"}